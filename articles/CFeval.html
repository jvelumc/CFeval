<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>CFeval • CFeval</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="CFeval">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CFeval</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/CFeval.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CFeval</h1>
            
      

      <div class="d-none name"><code>CFeval.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jvelumc.github.io/CFeval/">CFeval</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="toy-example">Toy example<a class="anchor" aria-label="anchor" href="#toy-example"></a>
</h2>
<div class="section level3">
<h3 id="model-development">Model development<a class="anchor" aria-label="anchor" href="#model-development"></a>
</h3>
<p>In this toy example, we simulate simulate data for binary outcome Y
and (point) treatment A, with the relation between A and Y confounded by
a variable L. Variable P is a prognostic variable for only the outcome.
The treatment reduces the risk on a bad outcome (Y = 1) in this
simulated example.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">L</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="fl">0.5</span> <span class="op">+</span> <span class="va">data</span><span class="op">$</span><span class="va">L</span> <span class="op">+</span> <span class="fl">1.25</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">P</span> <span class="op">-</span> <span class="fl">0.6</span> <span class="op">*</span> <span class="va">data</span><span class="op">$</span><span class="va">A</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df_dev</span> <span class="op">&lt;-</span> <span class="fu">simulate_data</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_dev</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id          L A          P Y</span></span>
<span><span class="co">#&gt; 1  1 -0.6264538 1  0.8500435 1</span></span>
<span><span class="co">#&gt; 2  2  0.1836433 0 -0.9253130 0</span></span>
<span><span class="co">#&gt; 3  3 -0.8356286 1  0.8935812 1</span></span>
<span><span class="co">#&gt; 4  4  1.5952808 1 -0.9410097 0</span></span>
<span><span class="co">#&gt; 5  5  0.3295078 1  0.5389521 1</span></span>
<span><span class="co">#&gt; 6  6 -0.8204684 0 -0.1819744 0</span></span></code></pre></div>
<p>Fitting a (logistic regression) model on this data without accounting
for the confounder L results in a model where treatment apparently
increases the risk on the outcome</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">naive_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">P</span> <span class="op">+</span> <span class="va">A</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, data <span class="op">=</span> <span class="va">df_dev</span><span class="op">)</span></span>
<span><span class="va">naive_model</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="co">#&gt;   (Intercept)             P             A </span></span>
<span><span class="co">#&gt; -0.0005233558  0.9986239220  0.4601290887</span></span></code></pre></div>
<p>Instead, we could adjust for the confounder L via (for example)
inverse probability of treatment weighting (iptw). [ref]</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">propensity_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">L</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, data <span class="op">=</span> <span class="va">df_dev</span><span class="op">)</span></span>
<span><span class="va">propensity_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">propensity_model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">iptw</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df_dev</span><span class="op">$</span><span class="va">A</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">propensity_score</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">propensity_score</span><span class="op">)</span></span>
<span></span>
<span><span class="va">causal_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">P</span> <span class="op">+</span> <span class="va">A</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, data <span class="op">=</span> <span class="va">df_dev</span>, weights <span class="op">=</span> <span class="va">iptw</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="va">causal_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; (Intercept)           P           A </span></span>
<span><span class="co">#&gt;   0.3100979   0.9750203  -0.2476580</span></span></code></pre></div>
<p>From now on we assume some model has been developed (be it a good or
a bad one), and we want to know if it provides accurate estimates of the
counterfactual risk on outcome under both treatment options a = 1 and a
= 0.</p>
</div>
<div class="section level3">
<h3 id="validation">Validation<a class="anchor" aria-label="anchor" href="#validation"></a>
</h3>
<p>We assume there is some validation dataset, which are independent
from data used for development of the models. This package aims to help
the user in assessing how well the predictions would match the
validation data if all individuals had followed a certain treatment
option of interest. Note that the causal structure of the validation
data set may be different from the causal structure of the development
data set, in which the model was trained. A model may for example be
developed from RCT data in which treatment was randomly assigned, while
we are validating in an observational cohort in which treatment is
confounded by some variables.</p>
<p>Let’s first simulate some validation data set. In this example, it is
generated using the same mechanism as the development data. It has 5000
rows instead of 1000.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_val</span> <span class="op">&lt;-</span> <span class="fu">simulate_data</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_val</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id          L A          P Y</span></span>
<span><span class="co">#&gt; 1  1  0.7391149 1  0.7051107 1</span></span>
<span><span class="co">#&gt; 2  2  0.3866087 0 -0.6268688 1</span></span>
<span><span class="co">#&gt; 3  3  1.2963972 1 -0.3230297 0</span></span>
<span><span class="co">#&gt; 4  4 -0.8035584 0  0.3596491 0</span></span>
<span><span class="co">#&gt; 5  5 -1.6026257 0 -0.9356634 0</span></span>
<span><span class="co">#&gt; 6  6  0.9332510 1 -1.0027030 0</span></span></code></pre></div>
<p>The main function CFscore() estimates several counterfactual
performance measures in a validation dataset, printing by default the
assumptions required for valid inference. The arguments supplied are the
models and the validation data, a formula for which the left hand side
denotes the outcome variable in the validation data, a treatment formula
for which the left hand side denotes the treatment variable and the
right hand side the confounders required to adjust for said treatment,
and the hypothetical treatment option for which you want to know how
well the model performs if everyone in the population was
(counterfactually) assigned to that treatment.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfscore</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CFscore.html">CFscore</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"naive model"</span> <span class="op">=</span> <span class="va">naive_model</span>, <span class="st">"causal model"</span> <span class="op">=</span> <span class="va">causal_model</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df_val</span>,</span>
<span>  outcome_formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  treatment_formula <span class="op">=</span> <span class="va">A</span> <span class="op">~</span> <span class="va">L</span>,</span>
<span>  treatment_of_interest <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"auc"</span>, <span class="st">"brier"</span>, <span class="st">"oeratio"</span>, <span class="st">"calplot"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfscore</span></span>
<span><span class="co">#&gt; Estimation of the performance of the prediction model in a</span></span>
<span><span class="co">#&gt;  counterfactual (CF) dataset where everyone's treatment A was set to 1.</span></span>
<span><span class="co">#&gt; The following assumptions must be satisfied for correct inference:</span></span>
<span><span class="co">#&gt; - Conditional exchangeability requires that given IP-weights are</span></span>
<span><span class="co">#&gt;  sufficient to adjust for confounding and selection bias between</span></span>
<span><span class="co">#&gt;  treatment and outcome.</span></span>
<span><span class="co">#&gt; - Positivity (assess $ipt$weights for outliers)</span></span>
<span><span class="co">#&gt; - Consistency</span></span>
<span><span class="co">#&gt; - No interference</span></span>
<span><span class="co">#&gt; - Correctly specified propensity formula. Estimated treatment model is</span></span>
<span><span class="co">#&gt;  logit(A) = -0.04 + 1.03*L. See also $ipt$model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         model   auc brier oeratio</span></span>
<span><span class="co">#&gt;    null model 0.500 0.249   1.000</span></span>
<span><span class="co">#&gt;   naive model 0.748 0.217   0.805</span></span>
<span><span class="co">#&gt;  causal model 0.748 0.205   0.934</span></span></code></pre></div>
<p><img src="CFeval_files/figure-html/unnamed-chunk-6-1.png" class="r-plt" alt="" width="384">
* Note that the AUC of the naive model is equal to the causal model. AUC
is driven entirely by how individuals are ranked, not by the magnitude
of the predicted probabilities. In this simple setting, P is the only
variable driving prognostic differences between individuals in the
prediction models. Even though IPTW changes the estimated coefficients,
it does not change the direction of the association with P. When
predicting outcomes under treatment for everyone, higher values of P
still correspond to higher predicted risk in both models, so individuals
are ranked in exactly the same way. As a result, both models produce
identical AUCs.</p>
</div>
<div class="section level3">
<h3 id="extra-options">Extra options<a class="anchor" aria-label="anchor" href="#extra-options"></a>
</h3>
<div class="section level4">
<h4 id="bootstrap">Bootstrap<a class="anchor" aria-label="anchor" href="#bootstrap"></a>
</h4>
<p>We can also run a bootstrap to estimate 95% confidence intervals
around the performance metrics.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/CFscore.html">CFscore</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"naive model"</span> <span class="op">=</span> <span class="va">naive_model</span>, <span class="st">"causal model"</span> <span class="op">=</span> <span class="va">causal_model</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df_val</span>,</span>
<span>  outcome_formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  treatment_formula <span class="op">=</span> <span class="va">A</span> <span class="op">~</span> <span class="va">L</span>,</span>
<span>  treatment_of_interest <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"auc"</span>, <span class="st">"brier"</span>, <span class="st">"oeratio"</span>, <span class="st">"calplot"</span><span class="op">)</span>,</span>
<span>  bootstrap <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  bootstrap_progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimation of the performance of the prediction model in a</span></span>
<span><span class="co">#&gt;  counterfactual (CF) dataset where everyone's treatment A was set to 1.</span></span>
<span><span class="co">#&gt; The following assumptions must be satisfied for correct inference:</span></span>
<span><span class="co">#&gt; - Conditional exchangeability requires that given IP-weights are</span></span>
<span><span class="co">#&gt;  sufficient to adjust for confounding and selection bias between</span></span>
<span><span class="co">#&gt;  treatment and outcome.</span></span>
<span><span class="co">#&gt; - Positivity (assess $ipt$weights for outliers)</span></span>
<span><span class="co">#&gt; - Consistency</span></span>
<span><span class="co">#&gt; - No interference</span></span>
<span><span class="co">#&gt; - Correctly specified propensity formula. Estimated treatment model is</span></span>
<span><span class="co">#&gt;  logit(A) = -0.04 + 1.03*L. See also $ipt$model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; auc</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         model   auc lower upper</span></span>
<span><span class="co">#&gt;    null model 0.500 0.500 0.500</span></span>
<span><span class="co">#&gt;   naive model 0.748 0.723 0.768</span></span>
<span><span class="co">#&gt;  causal model 0.748 0.723 0.768</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; brier</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         model brier lower upper</span></span>
<span><span class="co">#&gt;    null model 0.249 0.248 0.251</span></span>
<span><span class="co">#&gt;   naive model 0.217 0.209 0.227</span></span>
<span><span class="co">#&gt;  causal model 0.205 0.198 0.213</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; oeratio</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         model oeratio lower upper</span></span>
<span><span class="co">#&gt;    null model   1.000 0.956 1.051</span></span>
<span><span class="co">#&gt;   naive model   0.805 0.771 0.846</span></span>
<span><span class="co">#&gt;  causal model   0.934 0.895 0.981</span></span></code></pre></div>
<p><img src="CFeval_files/figure-html/unnamed-chunk-7-1.png" class="r-plt" alt="" width="384"><img src="CFeval_files/figure-html/unnamed-chunk-7-2.png" class="r-plt" alt="" width="384"><img src="CFeval_files/figure-html/unnamed-chunk-7-3.png" class="r-plt" alt="" width="384"><img src="CFeval_files/figure-html/unnamed-chunk-7-4.png" class="r-plt" alt="" width="384"></p>
<p>Further options are to use stabilized iptw, and time to event
outcomes.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jasper van Egeraat, Nan van Geloven, Ruth Keogh.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
