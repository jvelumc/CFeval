---
title: "CFeval"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Right censored outcome data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)
```

```{r setup}
library(CFeval)
library(survival)
set.seed(123)
```

# Evaluating performance for time to event data.
The README covers binary outcome. This vignette demonstrates how to estimate counterfactual performance metrics in right censored survival data. 

Just like in the binary outcome, a IPT-weighted pseudopopulation is built which represents a situation in which everybody gets the treatment of interest. On top of that, inverse probability of censor weights are used such that the pseudopopulation also represents a situation where nobody gets censored. 

## Example 1, non informative censoring

```{r}
simulate_time_to_event <- function(n, constant_baseline_haz, LP) {
  u <- runif(n)
  -log(u) / (constant_baseline_haz * exp(LP))
}

horizon <- 10
n <- 10000
data <- data.frame(
  L1 = rnorm(n, mean = 0),
  L2 = rbinom(n, 1, 0.5),
  P1 = rnorm(n, mean = 0),
  P2 = rbinom(n, 1, 0.5)
)
data$A <- rbinom(n, 1, plogis(0.2 + 1.2*data$L1 - 0.3*data$L2))

LP <- 0.8*data$L1 + 0.3*data$L2 + 0.5*data$P1 + 0.7*data$P2

# time0 is the uncensored untreated survival time,
# time1 is the uncensored treated   survival time 
data$time0 <- simulate_time_to_event(n, 0.04, LP)
data$time1 <- simulate_time_to_event(n, 0.04, LP - 0.5)

summary(data$time0)
summary(data$time1)

# time_a is the uncensored survival time corresponding to assigned treatment 
data$time_a <- ifelse(data$A == 1, data$time1, data$time0)

# uninformative censoring
data$censortime <- simulate_time_to_event(n, 0.02, 1)
summary(data$censortime)

data$status <- ifelse(data$time_a <= data$censortime, TRUE, FALSE)
data$time <- ifelse(data$status == TRUE,
                      data$time_a,
                      data$censortime)

summary(data$time)
summary(data$status)
```
Fit some models to validate:

```{r}
model_naive <- coxph(
  formula = Surv(time, status) ~ P1 + P2 + A,
  data = data
)

coefficients(model_naive)

trt_model <- glm(A ~ L1 + L2, family = "binomial", data = data)
propensity_score <- predict(trt_model, type = "response")

data$iptw <- 1 / ifelse(data$A == 1, propensity_score, 1 - propensity_score)

model_causal <- coxph(
  formula = Surv(time, status) ~ P1 + P2 + A,
  data = data,
  weights = iptw
)

coefficients(model_causal)
```

For this example, we validate these models on the same data that was used to develop them. We are interested in the counterfactual performance if every patient were to be assigned to treatment and remained uncensored, with a prediction horizon of 5 years. 

To account for the time to event data, the left hand side of the outcome_formula argument should be a survival object, and the right hand side the formula used to fit the IPCW model. In this case, we used non-informative censoring, so we leave the right hand side just $1$, and we specify to use the kaplan-meier to compute the ipc-weights.  

```{r, fig.width=6, fig.height=6}
cfs <- CFscore(
  object = list("naive model" = model_naive, "causal model" = model_causal),
  data = data,
  outcome_formula = Surv(time, status) ~ 1,
  treatment_formula = A ~ L1 + L2,
  treatment_of_interest = 1,
  time_horizon = 5,
  cens.model = "KM"
)
cfs
```

## Example 2, informative censoring
We can also account for informative censoring.

```{r}
data$censortime <- simulate_time_to_event(n, 0.04, 0.1*data$L1 + 0.5*data$P2)
summary(data$censortime)

data$status <- ifelse(data$time_a <= data$censortime, TRUE, FALSE)
data$time <- ifelse(data$status == TRUE,
                      data$time_a,
                      data$censortime)

summary(data$time)
summary(data$status)
```


We then set censoring method to "cox", and supply the formula needed for the censoring model as the right hand side of the outcome formula:

```{r, fig.width=6, fig.height=6}
CFscore(
  object = list("naive model" = model_naive, "causal model" = model_causal),
  data = data,
  outcome_formula = Surv(time, status) ~ L1 + P2,
  treatment_formula = A ~ L1 + L2,
  treatment_of_interest = 1,
  time_horizon = 5,
  cens.model = "cox",
  bootstrap = 100,
  bootstrap_progress = FALSE
)
```


